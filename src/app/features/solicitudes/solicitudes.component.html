<div class="app-container">
  <!-- Barra de navegación -->
  <div class="toolbar">
    <div class="toolbar-left">
      <a class="toolbar-title" routerLink="/home">Inicio</a>
      <a class="toolbar-title" routerLink="/register-solicitudes"
        >Registro de Solicitudes</a
      >
      <a class="toolbar-title active" routerLink="/solicitudes">Solicitudes</a>
      <a class="toolbar-title" routerLink="/control-refacciones"
        >Control de Refacciones</a
      >
      <a class="toolbar-title" routerLink="/refacciones">Refacciones</a>
      <a class="toolbar-title" routerLink="/accesos-permisos"
        >Accesos/Permisos</a
      >
    </div>
    <div class="toolbar-right">
      <div class="dropdown">
        <span class="profile">
          <i class="fas fa-user"></i> Perfil
          <i class="fa fa-caret-down"></i>
        </span>
        <div class="dropdown-content">
          <a (click)="logout()">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </div>

  <div class="solicitudes-container">
    <div class="header">
      <div class="logo">
        <h1>Sinsetec</h1>
        <p>Gestión de solicitudes</p>
      </div>
    </div>

    <main class="main-content">
      <!-- Mensajes de carga y error -->
      <div *ngIf="isLoading" class="loading-message">
        <i class="fas fa-spinner fa-spin"></i> Cargando solicitudes...
      </div>

      <div *ngIf="errorMessage" class="error-message">
        <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
      </div>

      <section class="actions-section">
        <div class="action-buttons">
          <!-- Botón de Cotización Simple -->
          <button
            class="action-button warning"
            (click)="crearCotizacionSimple()"
          >
            <i class="fas fa-file-alt"></i> Cotizar
          </button>

          <!-- Botón de Factura con formulario completo -->
          <button
            class="action-button primary"
            (click)="mostrarFormularioFactura()"
          >
            <i class="fas fa-file-invoice-dollar"></i> Facturar
          </button>

          <button
            class="action-button success"
            (click)="mostrarFormularioEntrega()"
          >
            <i class="fas fa-check-circle"></i> Entregado
          </button>
          <button class="action-button primary" (click)="exportarAExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
          <button class="action-button info" (click)="nuevaSolicitud()">
            <i class="fas fa-plus"></i> Nueva Solicitud
          </button>
        </div>

        <div class="filters">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              [(ngModel)]="terminoBusqueda"
              (input)="filtrarSolicitudes()"
              placeholder="Buscar por cliente, solicitante o ID"
            />
          </div>
          <div class="filter-group">
            <label for="filter-status">Estado:</label>
            <select
              id="filter-status"
              [(ngModel)]="filtroEstado"
              (change)="filtrarSolicitudes()"
            >
              <option value="">Todos</option>
              <option *ngFor="let estado of estados" [value]="estado">
                {{ estado }}
              </option>
            </select>
          </div>
        </div>
      </section>

      <section class="table-section">
        <div class="table-responsive">
          <table class="solicitudes-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Solicitante</th>
                <th>Fecha</th>
                <th>Tipo Trabajo</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let solicitud of solicitudesPaginadas"
                (click)="seleccionarSolicitud(solicitud)"
                [class.selected]="solicitudSeleccionada?.id === solicitud.id"
              >
                <td>{{ solicitud.cliente }}</td>
                <td>{{ solicitud.solicitante }}</td>
                <td>{{ solicitud.fecha_solicitud }}</td>
                <td>{{ solicitud.tipo_trabajo }}</td>
                <td>
                  <span
                    class="estado-badge"
                    [class]="'estado-' + obtenerClaseEstado(solicitud.estado)"
                  >
                    {{ solicitud.estado }}
                  </span>
                </td>
                <td class="acciones">
                  <button
                    class="accion-btn view-btn"
                    title="Ver detalles"
                    (click)="
                      verDetalles(solicitud.id); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="accion-btn edit-btn"
                    title="Editar"
                    (click)="
                      editarSolicitud(solicitud.id); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="accion-btn delete-btn"
                    title="Eliminar"
                    (click)="
                      confirmarEliminacion(solicitud); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="solicitudesFiltradas.length === 0 && !isLoading">
                <td colspan="6" class="no-results">
                  No se encontraron solicitudes que coincidan con los filtros
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pagination-info">
            Mostrando {{ (paginaActual - 1) * registrosPorPagina + 1 }} a
            {{
              Math.min(
                paginaActual * registrosPorPagina,
                solicitudesFiltradas.length
              )
            }}
            de {{ solicitudesFiltradas.length }} registros
          </div>
          <div class="pagination-controls">
            <button
              class="page-btn"
              [disabled]="paginaActual === 1"
              (click)="cambiarPagina(1)"
            >
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button
              class="page-btn"
              [disabled]="paginaActual === 1"
              (click)="cambiarPagina(paginaActual - 1)"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <span
              *ngFor="let pagina of getPaginasVisibles()"
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)"
              class="page-number"
            >
              {{ pagina }}
            </span>
            <button
              class="page-btn"
              [disabled]="paginaActual === totalPaginas"
              (click)="cambiarPagina(paginaActual + 1)"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
            <button
              class="page-btn"
              [disabled]="paginaActual === totalPaginas"
              (click)="cambiarPagina(totalPaginas)"
            >
              <i class="fas fa-angle-double-right"></i>
            </button>
          </div>
          <div class="page-size-selector">
            <label>Registros por página:</label>
            <select
              [(ngModel)]="registrosPorPagina"
              (change)="cambiarTamanoPagina()"
            >
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal Eliminar -->
    <div
      class="modal-overlay"
      *ngIf="showDeleteModal"
      (click)="cancelarEliminacion()"
    ></div>
    <div class="modal modal-sm" *ngIf="showDeleteModal">
      <div class="modal-header">
        <h3>Confirmar eliminación</h3>
        <button class="modal-close" (click)="cancelarEliminacion()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro que deseas eliminar la solicitud
          {{ solicitudAEliminar?.id }} del cliente
          {{ solicitudAEliminar?.cliente }}?
        </p>
        <p class="text-warning">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cancelarEliminacion()">
          Cancelar
        </button>
        <button class="btn btn-danger" (click)="eliminarSolicitud()">
          Eliminar
        </button>
      </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div
      class="modal-overlay"
      *ngIf="showViewModal"
      (click)="showViewModal = false"
    ></div>
    <div class="modal modal-lg" *ngIf="showViewModal">
      <div class="modal-header">
        <h3>Detalles completos de la solicitud</h3>
        <button class="modal-close" (click)="showViewModal = false">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="detail-grid" *ngIf="solicitudDetalle">
          <div class="detail-row">
            <span class="detail-label">Cliente:</span>
            <span class="detail-value">{{ solicitudDetalle.cliente }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Solicitante:</span>
            <span class="detail-value">{{ solicitudDetalle.solicitante }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Partida:</span>
            <span class="detail-value">{{ solicitudDetalle.partida }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Tipo de Trabajo:</span>
            <span class="detail-value">{{
              solicitudDetalle.tipo_trabajo
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Naturaleza del Trabajo:</span>
            <span class="detail-value">{{
              solicitudDetalle.naturaleza_trabajo
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Tipo de Máquina:</span>
            <span class="detail-value">{{
              solicitudDetalle.tipo_maquina
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ID Máquina:</span>
            <span class="detail-value">{{ solicitudDetalle.id_maquina }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Modelo de Máquina:</span>
            <span class="detail-value">{{
              solicitudDetalle.modelo_maquina
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Número de Serie:</span>
            <span class="detail-value">{{
              solicitudDetalle.numero_serie
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Comentario:</span>
            <span class="detail-value">{{ solicitudDetalle.comentario }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Fecha de Solicitud:</span>
            <span class="detail-value">{{
              solicitudDetalle.fecha_solicitud
            }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Estado:</span>
            <span
              class="detail-value estado-badge"
              [class]="'estado-' + obtenerClaseEstado(solicitudDetalle.estado)"
            >
              {{ solicitudDetalle.estado }}
            </span>
          </div>

          <!-- Información de Entrega -->
          <div class="detail-row" *ngIf="solicitudDetalle.recibido_por">
            <span class="detail-label">Recibido por:</span>
            <span class="detail-value">{{
              solicitudDetalle.recibido_por
            }}</span>
          </div>

          <div class="detail-row" *ngIf="solicitudDetalle.fecha_recibido">
            <span class="detail-label">Fecha de entrega:</span>
            <span class="detail-value">{{
              solicitudDetalle.fecha_recibido
            }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showViewModal = false">
          Cerrar
        </button>
      </div>
    </div>

    <!-- Modal Editar -->
    <div
      class="modal-overlay"
      *ngIf="showEditModal"
      (click)="showEditModal = false"
    ></div>
    <div class="modal modal-lg" *ngIf="showEditModal">
      <div class="modal-header">
        <h3>Editar Solicitud</h3>
        <button class="modal-close" (click)="showEditModal = false">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form *ngIf="solicitudDetalle" (ngSubmit)="guardarEdicion()">
          <div class="form-grid">
            <div class="form-row">
              <label>ID:</label>
              <input type="text" [value]="solicitudDetalle.id" readonly />
            </div>
            <div class="form-row">
              <label>Cliente:</label>
              <input type="text" [value]="solicitudDetalle.cliente" readonly />
            </div>
            <div class="form-row">
              <label>Solicitante:</label>
              <input
                type="text"
                [value]="solicitudDetalle.solicitante"
                readonly
              />
            </div>
            <div class="form-row">
              <label>Fecha de Solicitud:</label>
              <input
                type="text"
                [value]="solicitudDetalle.fecha_solicitud"
                readonly
              />
            </div>
            <div class="form-row">
              <label>Estado:</label>
              <input type="text" [value]="solicitudDetalle.estado" readonly />
            </div>

            <div class="form-row">
              <label for="edit-partida">Partida:</label>
              <input
                id="edit-partida"
                type="text"
                [(ngModel)]="solicitudDetalle.partida"
                name="partida"
              />
            </div>
            <div class="form-row">
              <label for="edit-tipo-trabajo">Tipo de Trabajo:</label>
              <select
                id="edit-tipo-trabajo"
                [(ngModel)]="solicitudDetalle.tipo_trabajo"
                name="tipo_trabajo"
              >
                <option value="">Seleccione...</option>
                <option value="Mantenimiento Correctivo">
                  Mantenimiento Correctivo
                </option>
                <option value="Mantenimiento Preventivo">
                  Mantenimiento Preventivo
                </option>
                <option value="Diagnóstico">Diagnóstico</option>
                <option value="Instalación">Instalación</option>
              </select>
            </div>
            <div class="form-row">
              <label for="edit-naturaleza">Naturaleza del Trabajo:</label>
              <select
                id="edit-naturaleza"
                [(ngModel)]="solicitudDetalle.naturaleza_trabajo"
                name="naturaleza_trabajo"
              >
                <option value="">Seleccione...</option>
                <option value="Mecánica">Mecánica</option>
                <option value="Eléctrica">Eléctrica</option>
                <option value="Electrónica">Electrónica</option>
                <option value="Hidráulica">Hidráulica</option>
              </select>
            </div>
            <div class="form-row">
              <label for="edit-tipo-maquina">Tipo de Máquina:</label>
              <select
                id="edit-tipo-maquina"
                [(ngModel)]="solicitudDetalle.tipo_maquina"
                name="tipo_maquina"
              >
                <option value="">Seleccione...</option>
                <option value="Centro de Maquinado">Centro de Maquinado</option>
                <option value="Generador">Generador</option>
                <option value="Equipo Eléctrico">Equipo Eléctrico</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div class="form-row">
              <label for="edit-id-maquina">ID Máquina:</label>
              <input
                id="edit-id-maquina"
                type="text"
                [(ngModel)]="solicitudDetalle.id_maquina"
                name="id_maquina"
              />
            </div>
            <div class="form-row">
              <label for="edit-modelo-maquina">Modelo de Máquina:</label>
              <input
                id="edit-modelo-maquina"
                type="text"
                [(ngModel)]="solicitudDetalle.modelo_maquina"
                name="modelo_maquina"
              />
            </div>
            <div class="form-row">
              <label for="edit-serie">Número de Serie:</label>
              <input
                id="edit-serie"
                type="text"
                [(ngModel)]="solicitudDetalle.numero_serie"
                name="numero_serie"
              />
            </div>
            <div class="form-row full-width">
              <label for="edit-comentario">Comentario:</label>
              <textarea
                id="edit-comentario"
                [(ngModel)]="solicitudDetalle.comentario"
                name="comentario"
              ></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showEditModal = false">
          Cancelar
        </button>
        <button
          class="btn btn-primary"
          (click)="guardarEdicion()"
          [disabled]="isLoading"
        >
          <span *ngIf="!isLoading">Guardar Cambios</span>
          <span *ngIf="isLoading"
            ><i class="fas fa-spinner fa-spin"></i> Guardando...</span
          >
        </button>
      </div>
    </div>

    <!-- Modal Entregado -->
    <div
      class="modal-overlay"
      *ngIf="showEntregaModal"
      (click)="showEntregaModal = false"
    ></div>
    <div class="modal modal-sm" *ngIf="showEntregaModal">
      <div class="modal-header">
        <h3>Confirmar Entrega</h3>
        <button class="modal-close" (click)="showEntregaModal = false">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro que deseas marcar como ENTREGADA la solicitud
          {{ solicitudSeleccionada?.id }}?
        </p>
        <div class="form-row">
          <label for="recibido-por">Recibido por:</label>
          <input
            id="recibido-por"
            type="text"
            [(ngModel)]="recibidoPor"
            name="recibidoPor"
            required
            placeholder="Nombre de quien recibe"
          />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="showEntregaModal = false">
          Cancelar
        </button>
        <button
          class="btn btn-success"
          (click)="confirmarEntrega()"
          [disabled]="isLoading || !recibidoPor"
        >
          <span *ngIf="!isLoading">Confirmar Entrega</span>
          <span *ngIf="isLoading"
            ><i class="fas fa-spinner fa-spin"></i> Procesando...</span
          >
        </button>
      </div>
    </div>
  </div>
</div>
