<!-- Barra de navegación -->
<div class="toolbar">
  <div class="toolbar-left">
    <a class="toolbar-title" routerLink="/home">Inicio</a>
    <a class="toolbar-title" routerLink="/register-solicitudes"
      >Registro de Solicitudes</a
    >
    <a class="toolbar-title active" routerLink="/solicitudes">Solicitudes</a>
    <a class="toolbar-title" routerLink="/control-refacciones"
      >Control de Refacciones</a
    >
    <a class="toolbar-title" routerLink="/refacciones">Refacciones</a>
    <a class="toolbar-title" routerLink="/accesos-permisos">Accesos/Permisos</a>
  </div>
  <div class="toolbar-right">
    <div class="dropdown">
      <span class="profile">
        <i class="fas fa-user"></i> Perfil
        <i class="fa fa-caret-down"></i>
      </span>
      <div class="dropdown-content">
        <a (click)="logout()">Cerrar sesión</a>
      </div>
    </div>
  </div>
</div>

<div class="solicitudes-container">
  <div class="header">
    <div class="logo">
      <h1>Sinsetec</h1>
      <p>Gestión de solicitudes</p>
    </div>
  </div>

  <main class="main-content">
    <!-- Mensajes de carga y error -->
    <div *ngIf="isLoading" class="loading-message">
      <i class="fas fa-spinner fa-spin"></i> Cargando solicitudes...
    </div>

    <div *ngIf="errorMessage" class="error-message">
      <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
    </div>

    <section class="actions-section">
      <div class="action-buttons">
        <button class="action-button warning" (click)="crearCotizacionSimple()">
          <i class="fas fa-file-alt"></i> Cotizar
        </button>

        <button
          class="action-button primary"
          (click)="mostrarFormularioFactura()"
        >
          <i class="fas fa-file-invoice-dollar"></i> Facturar
        </button>

        <button
          class="action-button success"
          (click)="mostrarFormularioEntrega()"
        >
          <i class="fas fa-check-circle"></i> Entregado
        </button>
        <button class="action-button primary" (click)="exportarAExcel()">
          <i class="fas fa-file-excel"></i> Exportar a Excel
        </button>
        <button class="action-button info" (click)="nuevaSolicitud()">
          <i class="fas fa-plus"></i> Nueva Solicitud
        </button>
      </div>

      <div class="filters">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input
            type="text"
            [(ngModel)]="terminoBusqueda"
            (input)="filtrarSolicitudes()"
            placeholder="Buscar por cliente, solicitante o ID"
          />
        </div>
        <div class="filter-group">
          <label for="filter-status">Estado:</label>
          <select
            id="filter-status"
            [(ngModel)]="filtroEstado"
            (change)="filtrarSolicitudes()"
          >
            <option value="">Todos</option>
            <option *ngFor="let estado of estados" [value]="estado">
              {{ estado }}
            </option>
          </select>
        </div>
      </div>
    </section>

    <section class="table-section">
      <div class="table-responsive">
        <table class="solicitudes-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Solicitante</th>
              <th>Fecha</th>
              <th>Tipo Trabajo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let solicitud of solicitudesPaginadas"
              (click)="seleccionarSolicitud(solicitud)"
              [class.selected]="solicitudSeleccionada?.id === solicitud.id"
            >
              <td>{{ solicitud.cliente }}</td>
              <td>{{ solicitud.solicitante }}</td>
              <td>{{ solicitud.fecha_solicitud }}</td>
              <td>{{ solicitud.tipo_trabajo }}</td>
              <td>
                <span
                  class="estado-badge"
                  [class]="'estado-' + obtenerClaseEstado(solicitud.estado)"
                >
                  {{ solicitud.estado }}
                </span>
              </td>
              <td class="acciones">
                <button
                  class="accion-btn view-btn"
                  title="Ver detalles"
                  (click)="verDetalles(solicitud.id); $event.stopPropagation()"
                >
                  <i class="fas fa-eye"></i>
                </button>
                <button
                  class="accion-btn edit-btn"
                  title="Editar"
                  (click)="
                    editarSolicitud(solicitud.id); $event.stopPropagation()
                  "
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  class="accion-btn delete-btn"
                  title="Eliminar"
                  (click)="
                    confirmarEliminacion(solicitud); $event.stopPropagation()
                  "
                >
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="solicitudesFiltradas.length === 0 && !isLoading">
              <td colspan="6" class="no-results">
                No se encontraron solicitudes que coincidan con los filtros
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <div class="pagination-info">
          Mostrando {{ (paginaActual - 1) * registrosPorPagina + 1 }} a
          {{
            Math.min(
              paginaActual * registrosPorPagina,
              solicitudesFiltradas.length
            )
          }}
          de {{ solicitudesFiltradas.length }} registros
        </div>
        <div class="pagination-controls">
          <button
            class="page-btn"
            [disabled]="paginaActual === 1"
            (click)="cambiarPagina(1)"
          >
            <i class="fas fa-angle-double-left"></i>
          </button>
          <button
            class="page-btn"
            [disabled]="paginaActual === 1"
            (click)="cambiarPagina(paginaActual - 1)"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <span
            *ngFor="let pagina of getPaginasVisibles()"
            [class.active]="pagina === paginaActual"
            (click)="cambiarPagina(pagina)"
            class="page-number"
          >
            {{ pagina }}
          </span>
          <button
            class="page-btn"
            [disabled]="paginaActual === totalPaginas"
            (click)="cambiarPagina(paginaActual + 1)"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
          <button
            class="page-btn"
            [disabled]="paginaActual === totalPaginas"
            (click)="cambiarPagina(totalPaginas)"
          >
            <i class="fas fa-angle-double-right"></i>
          </button>
        </div>
        <div class="page-size-selector">
          <label>Registros por página:</label>
          <select
            [(ngModel)]="registrosPorPagina"
            (change)="cambiarTamanoPagina()"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Eliminar -->
  <div
    class="modal-overlay"
    *ngIf="showDeleteModal"
    (click)="cancelarEliminacion()"
  ></div>
  <div class="modal modal-sm" *ngIf="showDeleteModal">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="modal-close" (click)="cancelarEliminacion()">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <p>
        ¿Estás seguro que deseas eliminar la solicitud
        {{ solicitudAEliminar?.id }} del cliente
        {{ solicitudAEliminar?.cliente }}?
      </p>
      <p class="text-warning">Esta acción no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelarEliminacion()">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="eliminarSolicitud()">
        Eliminar
      </button>
    </div>
  </div>

  <!-- Modal Ver Detalles -->
  <div
    class="modal-overlay"
    *ngIf="showViewModal"
    (click)="showViewModal = false"
  ></div>
  <div class="modal modal-lg" *ngIf="showViewModal">
    <div class="modal-header">
      <h3>Detalles completos de la solicitud</h3>
      <button class="modal-close" (click)="showViewModal = false">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" *ngIf="solicitudDetalle">
        <!-- Campos principales -->
        <div class="detail-row full-width">
          <h4
            style="
              margin: 20px 0 10px 0;
              border-bottom: 1px solid #ddd;
              padding-bottom: 5px;
            "
          >
            Información General
          </h4>
        </div>
        <div class="detail-row">
          <span class="detail-label">Cliente:</span>
          <span class="detail-value">{{ solicitudDetalle.cliente }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Solicitante:</span>
          <span class="detail-value">{{ solicitudDetalle.solicitante }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Empresa:</span>
          <span class="detail-value">{{
            solicitudDetalle.empresa || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Representante:</span>
          <span class="detail-value">{{
            solicitudDetalle.representante || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Proveedor:</span>
          <span class="detail-value">{{
            solicitudDetalle.proveedor || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Partida:</span>
          <span class="detail-value">{{ solicitudDetalle.partida }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tipo de Trabajo:</span>
          <span class="detail-value">{{ solicitudDetalle.tipo_trabajo }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Naturaleza del Trabajo:</span>
          <span class="detail-value">{{
            solicitudDetalle.naturaleza_trabajo
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tipo de Máquina:</span>
          <span class="detail-value">{{ solicitudDetalle.tipo_maquina }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ID Máquina:</span>
          <span class="detail-value">{{
            solicitudDetalle.id_maquina || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Modelo de Máquina:</span>
          <span class="detail-value">{{
            solicitudDetalle.modelo_maquina
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Número de Serie:</span>
          <span class="detail-value">{{ solicitudDetalle.numero_serie }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Horas:</span>
          <span class="detail-value">{{ solicitudDetalle.hora || "N/A" }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ubicación:</span>
          <span class="detail-value">{{
            solicitudDetalle.ubicacion || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tiempo de Entrega:</span>
          <span class="detail-value">{{
            solicitudDetalle.tiempo_entrega || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Datos de Contacto:</span>
          <span class="detail-value">{{
            solicitudDetalle.datos_contacto || "N/A"
          }}</span>
        </div>
        <div class="detail-row full-width">
          <span class="detail-label">Comentario y Observaciones:</span>
          <span class="detail-value">{{ solicitudDetalle.comentario }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Fecha de Solicitud:</span>
          <span class="detail-value">{{
            solicitudDetalle.fecha_solicitud
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Estado:</span>
          <span
            class="detail-value estado-badge"
            [class]="'estado-' + obtenerClaseEstado(solicitudDetalle.estado)"
          >
            {{ solicitudDetalle.estado }}
          </span>
        </div>

        <!-- SECCIÓN DE PARTIDAS - INFORMACIÓN ESPECÍFICA -->
        <div class="detail-row full-width">
          <h4
            style="
              margin: 20px 0 10px 0;
              border-bottom: 1px solid #ddd;
              padding-bottom: 5px;
            "
          >
            Gestión de Partidas
          </h4>
        </div>

        <div class="detail-row">
          <span class="detail-label">Tipo de trabajo:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.tipoTrabajo || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Naturaleza:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.naturalezaTrabajo || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tipo de máquina:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.tipoMaquina || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Número de serie:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.numeroSerie || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ID de máquina:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.idMaquina || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Modelo de máquina:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.modeloMaquina || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Horas:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.hora || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Contacto que recibe:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.contactoRecibe || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tiempo de entrega:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.tiempoEntrega || "N/A"
          }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ubicación:</span>
          <span class="detail-value">{{
            solicitudDetalle.detallesPartida?.ubicacion || "N/A"
          }}</span>
        </div>

        <!-- SECCIÓN DE FACTURACIÓN -->
        <div class="detail-row full-width">
          <h4
            style="
              margin: 20px 0 10px 0;
              border-bottom: 1px solid #ddd;
              padding-bottom: 5px;
            "
          >
            Información de Facturación
          </h4>
        </div>

        <div class="detail-row full-width">
          <div class="facturacion-section">
            <table class="facturacion-table">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>IVA %</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of solicitudDetalle.itemsFactura || []">
                  <td>{{ item.descripcion || "N/A" }}</td>
                  <td>{{ item.cantidad || "0" }}</td>
                  <td>{{ item.precioUnitario | currency }}</td>
                  <td>{{ item.iva || "0" }}%</td>
                  <td>{{ item.total | currency }}</td>
                </tr>
                <tr
                  *ngIf="
                    !solicitudDetalle.itemsFactura ||
                    solicitudDetalle.itemsFactura.length === 0
                  "
                >
                  <td colspan="5" style="text-align: center">
                    No hay items registrados
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" style="text-align: right; font-weight: bold">
                    Subtotal:
                  </td>
                  <td colspan="2">{{ calcularSubtotal() | currency }}</td>
                </tr>
                <tr>
                  <td colspan="3" style="text-align: right; font-weight: bold">
                    IVA Total:
                  </td>
                  <td colspan="2">{{ calcularIVA() | currency }}</td>
                </tr>
                <tr>
                  <td colspan="3" style="text-align: right; font-weight: bold">
                    Total General:
                  </td>
                  <td colspan="2">{{ calcularTotalGeneral() | currency }}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Información de Entrega -->
        <div class="detail-row" *ngIf="solicitudDetalle.recibido_por">
          <span class="detail-label">Recibido por:</span>
          <span class="detail-value">{{ solicitudDetalle.recibido_por }}</span>
        </div>

        <div class="detail-row" *ngIf="solicitudDetalle.fecha_recibido">
          <span class="detail-label">Fecha de entrega:</span>
          <span class="detail-value">{{
            solicitudDetalle.fecha_recibido
          }}</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showViewModal = false">
        Cerrar
      </button>
      <button
        class="btn btn-primary"
        (click)="editarSolicitud(solicitudDetalle!.id)"
      >
        Editar
      </button>
    </div>
  </div>

  <!-- Modal Editar -->
  <div
    class="modal-overlay"
    *ngIf="showEditModal"
    (click)="showEditModal = false"
  ></div>
  <div class="modal modal-lg" *ngIf="showEditModal">
    <div class="modal-header">
      <h3>Editar Solicitud</h3>
      <button class="modal-close" (click)="showEditModal = false">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form *ngIf="solicitudDetalle" (ngSubmit)="guardarEdicion()">
        <div class="form-grid">
          <!-- Campos de solo lectura -->
          <div class="form-row">
            <label>ID:</label>
            <input type="text" [value]="solicitudDetalle.id" readonly />
          </div>
          <div class="form-row">
            <label>Cliente:</label>
            <input type="text" [value]="solicitudDetalle.cliente" readonly />
          </div>
          <div class="form-row">
            <label>Solicitante:</label>
            <input
              type="text"
              [value]="solicitudDetalle.solicitante"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Empresa:</label>
            <input
              type="text"
              [value]="solicitudDetalle.empresa || 'N/A'"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Representante:</label>
            <input
              type="text"
              [value]="solicitudDetalle.representante || 'N/A'"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Proveedor:</label>
            <input
              type="text"
              [value]="solicitudDetalle.proveedor || 'N/A'"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Fecha de Solicitud:</label>
            <input
              type="text"
              [value]="solicitudDetalle.fecha_solicitud"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Estado:</label>
            <input type="text" [value]="solicitudDetalle.estado" readonly />
          </div>
          <div class="form-row">
            <label>Partida:</label>
            <input type="text" [value]="solicitudDetalle.partida" readonly />
          </div>
          <div class="form-row">
            <label>Tipo de Trabajo:</label>
            <input
              type="text"
              [value]="solicitudDetalle.tipo_trabajo"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Naturaleza del Trabajo:</label>
            <input
              type="text"
              [value]="solicitudDetalle.naturaleza_trabajo"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Tipo de Máquina:</label>
            <input
              type="text"
              [value]="solicitudDetalle.tipo_maquina"
              readonly
            />
          </div>

          <!-- Campos editables -->
          <div class="form-row">
            <label for="edit-id-maquina">ID Máquina:</label>
            <input
              id="edit-tipo-maquina"
              type="text"
              [(ngModel)]="solicitudDetalle.tipo_maquina"
              name="tipo_maquina"
            />
          </div>
          <div class="form-row">
            <label for="edit-modelo-maquina">Modelo de Máquina:</label>
            <input
              id="edit-modelo-maquina"
              type="text"
              [(ngModel)]="solicitudDetalle.modelo_maquina"
              name="modelo_maquina"
            />
          </div>
          <div class="form-row">
            <label for="edit-serie">Número de Serie:</label>
            <input
              id="edit-serie"
              type="text"
              [(ngModel)]="solicitudDetalle.numero_serie"
              name="numero_serie"
            />
          </div>
          <div class="form-row">
            <label for="edit-tiempo-entrega">Tiempo de Entrega:</label>
            <input
              id="edit-tiempo-entrega"
              type="text"
              [(ngModel)]="solicitudDetalle.tiempo_entrega"
              name="tiempo_entrega"
            />
          </div>
          <div class="form-row">
            <label for="edit-horas">Horas:</label>
            <input
              id="edit-horas"
              type="number"
              [(ngModel)]="solicitudDetalle.hora"
              name="horas"
            />
          </div>
          <div class="form-row">
            <label for="edit-ubicacion">Ubicación:</label>
            <input
              id="edit-ubicacion"
              type="text"
              [(ngModel)]="solicitudDetalle.ubicacion"
              name="ubicacion"
            />
          </div>
          <div class="form-row">
            <label for="edit-datos-contacto">Datos de Contacto:</label>
            <input
              id="edit-datos-contacto"
              type="text"
              [(ngModel)]="solicitudDetalle.datos_contacto"
              name="datos_contacto"
            />
          </div>
          <div class="form-row full-width">
            <label for="edit-comentario">Comentario y Observaciones:</label>
            <textarea
              id="edit-comentario"
              [(ngModel)]="solicitudDetalle.comentario"
              name="comentario"
            ></textarea>
          </div>

          <!-- SECCIÓN DE PARTIDAS EDITABLE -->
          <div class="form-row full-width">
            <h4
              style="
                margin: 20px 0 10px 0;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
              "
            >
              Gestión de Partidas
            </h4>
          </div>

          <div class="form-row">
            <label for="edit-tipo-trabajo-partida">Tipo de trabajo:</label>
            <input
              id="edit-tipo-trabajo-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.tipoTrabajo || ''"
              (ngModelChange)="actualizarDetallePartida('tipoTrabajo', $event)"
              name="tipoTrabajo"
            />
          </div>
          <div class="form-row">
            <label for="edit-naturaleza-partida">Naturaleza:</label>
            <input
              id="edit-naturaleza-partida"
              type="text"
              [ngModel]="
                solicitudDetalle.detallesPartida?.naturalezaTrabajo || ''
              "
              (ngModelChange)="
                actualizarDetallePartida('naturalezaTrabajo', $event)
              "
              name="naturalezaTrabajo"
            />
          </div>
          <div class="form-row">
            <label for="edit-tipo-maquina-partida">Tipo de máquina:</label>
            <input
              id="edit-tipo-maquina-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.tipoMaquina || ''"
              (ngModelChange)="actualizarDetallePartida('tipoMaquina', $event)"
              name="tipoMaquina"
            />
          </div>
          <div class="form-row">
            <label for="edit-numero-serie-partida">Número de serie:</label>
            <input
              id="edit-numero-serie-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.numeroSerie || ''"
              (ngModelChange)="actualizarDetallePartida('numeroSerie', $event)"
              name="numeroSerie"
            />
          </div>
          <div class="form-row">
            <label for="edit-id-maquina-partida">ID de máquina:</label>
            <input
              id="edit-id-maquina-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.idMaquina || ''"
              (ngModelChange)="actualizarDetallePartida('idMaquina', $event)"
              name="idMaquina"
            />
          </div>
          <div class="form-row">
            <label for="edit-modelo-maquina-partida">Modelo de máquina:</label>
            <input
              id="edit-modelo-maquina-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.modeloMaquina || ''"
              (ngModelChange)="
                actualizarDetallePartida('modeloMaquina', $event)
              "
              name="modeloMaquina"
            />
          </div>
          <div class="form-row">
            <label for="edit-horas-partida">Horas:</label>
            <input
              id="edit-horas-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.hora || ''"
              (ngModelChange)="actualizarDetallePartida('hora', $event)"
              name="hora"
            />
          </div>
          <div class="form-row">
            <label for="edit-contacto-partida">Contacto que recibe:</label>
            <input
              id="edit-contacto-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.contactoRecibe || ''"
              (ngModelChange)="
                actualizarDetallePartida('contactoRecibe', $event)
              "
              name="contactoRecibe"
            />
          </div>
          <div class="form-row">
            <label for="edit-tiempo-entrega-partida">Tiempo de entrega:</label>
            <input
              id="edit-tiempo-entrega-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.tiempoEntrega || ''"
              (ngModelChange)="
                actualizarDetallePartida('tiempoEntrega', $event)
              "
              name="tiempoEntrega"
            />
          </div>
          <div class="form-row">
            <label for="edit-ubicacion-partida">Ubicación:</label>
            <input
              id="edit-ubicacion-partida"
              type="text"
              [ngModel]="solicitudDetalle.detallesPartida?.ubicacion || ''"
              (ngModelChange)="actualizarDetallePartida('ubicacion', $event)"
              name="ubicacion"
            />
          </div>

          <!-- SECCIÓN DE FACTURACIÓN -->
          <div class="form-row full-width">
            <h4
              style="
                margin: 20px 0 10px 0;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
              "
            >
              Información de Facturación
            </h4>
          </div>
          <div class="form-row full-width">
            <div class="facturacion-section">
              <table class="facturacion-table">
                <thead>
                  <tr>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>IVA %</th>
                    <th>Total</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let item of solicitudDetalle.itemsFactura || [];
                      let i = index
                    "
                  >
                    <td>
                      <input
                        type="text"
                        [(ngModel)]="item.descripcion"
                        [name]="'descripcion_' + i"
                        class="facturacion-input"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        [(ngModel)]="item.cantidad"
                        [name]="'cantidad_' + i"
                        min="0"
                        (change)="calcularTotalItem(item)"
                        class="facturacion-input"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        [(ngModel)]="item.precioUnitario"
                        [name]="'precioUnitario_' + i"
                        min="0"
                        step="0.01"
                        (change)="calcularTotalItem(item)"
                        class="facturacion-input"
                      />
                    </td>
                    <td>
                      <input
                        type="number"
                        [(ngModel)]="item.iva"
                        [name]="'iva_' + i"
                        min="0"
                        step="0.01"
                        (change)="calcularTotalItem(item)"
                        class="facturacion-input"
                      />
                      %
                    </td>
                    <td class="text-right">{{ item.total | currency }}</td>
                    <td class="text-center">
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        (click)="eliminarItemFactura(i)"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <tr
                    *ngIf="
                      !solicitudDetalle.itemsFactura ||
                      solicitudDetalle.itemsFactura.length === 0
                    "
                  >
                    <td colspan="6" class="text-center">
                      No hay items registrados
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="6" class="text-center">
                      <button
                        type="button"
                        class="btn btn-primary btn-sm"
                        (click)="agregarItemFactura()"
                      >
                        <i class="fas fa-plus"></i> Agregar Item
                      </button>
                    </td>
                  </tr>
                  <tr class="facturacion-total">
                    <td colspan="4" class="text-right font-weight-bold">
                      Subtotal:
                    </td>
                    <td colspan="2" class="text-right">
                      {{ calcularSubtotal() | currency }}
                    </td>
                  </tr>
                  <tr class="facturacion-total">
                    <td colspan="4" class="text-right font-weight-bold">
                      IVA Total:
                    </td>
                    <td colspan="2" class="text-right">
                      {{ calcularIVA() | currency }}
                    </td>
                  </tr>
                  <tr class="facturacion-total grand-total">
                    <td colspan="4" class="text-right font-weight-bold">
                      Total General:
                    </td>
                    <td colspan="2" class="text-right">
                      {{ calcularTotalGeneral() | currency }}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showEditModal = false">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="guardarEdicion()">
        Guardar Cambios
      </button>
    </div>
  </div>
</div>
