<div class="app-container">
  <!-- Barra de navegación -->
  <div class="toolbar">
    <div class="toolbar-left">
      <a class="toolbar-title" routerLink="/home">Inicio</a>
      <a class="toolbar-title" routerLink="/register-solicitudes"
        >Registro de Solicitudes</a
      >
      <a class="toolbar-title active" routerLink="/solicitudes">Solicitudes</a>
      <a class="toolbar-title" routerLink="/control-refacciones"
        >Control de Refacciones</a
      >
      <a class="toolbar-title" routerLink="/accesos-permisos"
        >Accesos/Permisos</a
      >
    </div>
    <div class="toolbar-right">
      <div class="dropdown">
        <span class="profile">
          <i class="fas fa-user"></i> Perfil
          <i class="fa fa-caret-down"></i>
        </span>
        <div class="dropdown-content">
          <a (click)="logout()">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </div>

  <div class="solicitudes-container">
    <div class="header">
      <div class="logo">
        <h1>Sinsetec</h1>
        <p>Gestión de solicitudes</p>
      </div>
    </div>

    <main class="main-content">
      <!-- Mensajes de carga y error -->
      <div *ngIf="isLoading" class="loading-message">
        <i class="fas fa-spinner fa-spin"></i> Cargando solicitudes...
      </div>

      <div *ngIf="errorMessage" class="error-message">
        <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
      </div>

      <section class="actions-section">
        <div class="action-buttons">
          <button
            class="action-button primary"
            (click)="mostrarFormularioFactura()"
          >
            <i class="fas fa-file-invoice-dollar"></i> Facturar
          </button>
          <button
            class="action-button success"
            (click)="mostrarFormularioEnterado()"
          >
            <i class="fas fa-check-circle"></i> Enterado
          </button>
          <button class="action-button primary" (click)="exportarAExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
          <button class="action-button info" (click)="nuevaSolicitud()">
            <i class="fas fa-plus"></i> Nueva Solicitud
          </button>
        </div>

        <div class="filters">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              [(ngModel)]="terminoBusqueda"
              (input)="filtrarSolicitudes()"
              placeholder="Buscar por cliente, solicitante o ID"
            />
          </div>
          <div class="filter-group">
            <label for="filter-status">Estado:</label>
            <select
              id="filter-status"
              [(ngModel)]="filtroEstado"
              (change)="filtrarSolicitudes()"
            >
              <option value="">Todos</option>
              <option *ngFor="let estado of estados" [value]="estado">
                {{ estado }}
              </option>
            </select>
          </div>
        </div>
      </section>

      <section class="table-section">
        <div class="table-responsive">
          <table class="solicitudes-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Solicitante</th>
                <th>Fecha</th>
                <th>Tipo Trabajo</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let solicitud of solicitudesPaginadas"
                (click)="seleccionarSolicitud(solicitud)"
                [class.selected]="solicitudSeleccionada?.id === solicitud.id"
              >
                <td>{{ solicitud.id }}</td>
                <td>{{ solicitud.cliente }}</td>
                <td>{{ solicitud.solicitante }}</td>
                <td>{{ solicitud.fecha_solicitud }}</td>
                <td>{{ solicitud.tipo_trabajo }}</td>
                <td>
                  <span
                    class="estado-badge"
                    [class]="'estado-' + solicitud.estado.toLowerCase()"
                  >
                    {{ solicitud.estado }}
                  </span>
                </td>
                <td class="acciones">
                  <button
                    class="accion-btn view-btn"
                    title="Ver detalles"
                    (click)="
                      verDetalles(solicitud.id); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="accion-btn edit-btn"
                    title="Editar"
                    (click)="
                      editarSolicitud(solicitud.id); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="accion-btn delete-btn"
                    title="Eliminar"
                    (click)="
                      confirmarEliminacion(solicitud); $event.stopPropagation()
                    "
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="solicitudesFiltradas.length === 0 && !isLoading">
                <td colspan="7" class="no-results">
                  No se encontraron solicitudes que coincidan con los filtros
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pagination-info">
            Mostrando {{ (paginaActual - 1) * registrosPorPagina + 1 }} a
            {{
              Math.min(
                paginaActual * registrosPorPagina,
                solicitudesFiltradas.length
              )
            }}
            de {{ solicitudesFiltradas.length }} registros
          </div>
          <div class="pagination-controls">
            <button
              class="page-btn"
              [disabled]="paginaActual === 1"
              (click)="cambiarPagina(1)"
            >
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button
              class="page-btn"
              [disabled]="paginaActual === 1"
              (click)="cambiarPagina(paginaActual - 1)"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <span
              *ngFor="let pagina of getPaginasVisibles()"
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)"
              class="page-number"
            >
              {{ pagina }}
            </span>
            <button
              class="page-btn"
              [disabled]="paginaActual === totalPaginas"
              (click)="cambiarPagina(paginaActual + 1)"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
            <button
              class="page-btn"
              [disabled]="paginaActual === totalPaginas"
              (click)="cambiarPagina(totalPaginas)"
            >
              <i class="fas fa-angle-double-right"></i>
            </button>
          </div>
          <div class="page-size-selector">
            <label>Registros por página:</label>
            <select
              [(ngModel)]="registrosPorPagina"
              (change)="cambiarTamanoPagina()"
            >
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal Eliminar -->
    <div
      class="modal-overlay"
      *ngIf="showDeleteModal"
      (click)="cancelarEliminacion()"
    ></div>
    <div class="modal modal-sm" *ngIf="showDeleteModal">
      <div class="modal-header">
        <h3>Confirmar eliminación</h3>
        <button class="modal-close" (click)="cancelarEliminacion()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro que deseas eliminar la solicitud
          {{ solicitudAEliminar?.id }} del cliente
          {{ solicitudAEliminar?.cliente }}?
        </p>
        <p class="text-warning">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cancelarEliminacion()">
          Cancelar
        </button>
        <button class="btn btn-danger" (click)="eliminarSolicitud()">
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
