<div class="app-container">
  <!-- Barra de navegación -->
  <div class="toolbar">
    <div class="toolbar-left">
      <a class="toolbar-title" routerLink="/home">Inicio</a>
      <a class="toolbar-title" routerLink="/register-solicitudes"
        >Registro de Solicitudes</a
      >
      <a class="toolbar-title" routerLink="/solicitudes">Solicitudes</a>
      <a class="toolbar-title" routerLink="/control-refacciones"
        >Registro de Refacciones</a
      >
      <a class="toolbar-title" routerLink="/refacciones">Refacciones</a>
      <a class="toolbar-title active" routerLink="/accesos-permisos"
        >Accesos/Permisos</a
      >
    </div>
    <div class="toolbar-right">
      <div class="dropdown">
        <span class="profile">
          <i class="fas fa-user"></i> Perfil
          <i class="fa fa-caret-down"></i>
        </span>
        <div class="dropdown-content">
          <a (click)="logout()">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </div>

  <div class="refacciones-container">
    <div class="header">
      <div class="logo">
        <h1>Accesos y Permisos</h1>
        <p>
          Gestión de permisos de usuarios - {{ empresaSeleccionada?.nombre }}
        </p>
      </div>
      <div class="header-actions">
        <!-- Selector de empresa -->
        <div class="empresa-selector">
          <label>Empresa:</label>
          <select
            [ngModel]="empresaSeleccionada"
            (ngModelChange)="
              empresaSeleccionada = $event; cambiarEmpresaSeleccionada()
            "
            [compareWith]="compareEmpresas"
          >
            <option *ngFor="let empresa of empresas" [ngValue]="empresa">
              {{ empresa.nombre }}
            </option>
          </select>
        </div>
        <button class="btn-primary" (click)="mostrarFormularioRegistro = true">
          <i class="fas fa-plus"></i> Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Formulario de registro de nuevo usuario -->
    <div *ngIf="mostrarFormularioRegistro" class="registro-form">
      <h3>Registrar Nuevo Usuario</h3>
      <div class="form-group">
        <label>Nombre completo:</label>
        <input
          type="text"
          [(ngModel)]="nuevoUsuario.nombre"
          placeholder="Nombre completo"
        />
      </div>
      <div class="form-group">
        <label>Email:</label>
        <input
          type="email"
          [(ngModel)]="nuevoUsuario.email"
          placeholder="Correo electrónico"
        />
      </div>
      <div class="form-group">
        <label>Contraseña:</label>
        <input
          type="password"
          [(ngModel)]="nuevoUsuario.password"
          placeholder="Contraseña"
        />
      </div>
      <div class="form-group">
        <label>Empresa:</label>
        <select [(ngModel)]="nuevoUsuario.empresa_id">
          <option *ngFor="let empresa of empresas" [value]="empresa.id">
            {{ empresa.nombre }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label>Rol:</label>
        <select [(ngModel)]="nuevoUsuario.rol">
          <option value="Usuario">Usuario</option>
          <option value="Administrador">Administrador</option>
          <option value="Supervisor">Supervisor</option>
        </select>
      </div>
      <div class="form-buttons">
        <button
          class="btn-secondary"
          (click)="mostrarFormularioRegistro = false"
        >
          Cancelar
        </button>
        <button class="btn-primary" (click)="registrarNuevoUsuario()">
          Registrar
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading">
      <i class="fas fa-spinner fa-spin"></i> Cargando...
    </div>

    <!-- Contenido principal -->
    <div *ngIf="!isLoading" class="permisos-content">
      <!-- Buscador -->
      <div class="search-control">
        <input
          type="text"
          [(ngModel)]="buscadorUsuario"
          placeholder="Buscar usuario por nombre o email..."
          class="search-input"
        />
        <i class="fas fa-search search-icon"></i>
      </div>

      <!-- Lista de usuarios -->
      <div class="usuarios-list">
        <h3>
          Usuarios de {{ empresaSeleccionada?.nombre }} ({{ usuarios.length }})
        </h3>
        <div *ngIf="usuarios.length === 0" class="empty-state">
          <i class="fas fa-users"></i>
          <p>No hay usuarios registrados en esta empresa</p>
        </div>

        <div class="usuarios-grid">
          <div
            *ngFor="let usuario of usuariosFiltrados"
            class="usuario-card"
            [class.selected]="usuarioSeleccionado?.id === usuario.id"
          >
            <div class="usuario-info" (click)="seleccionarUsuario(usuario)">
              <h4>{{ usuario.nombre }}</h4>
              <p>{{ usuario.email }}</p>
              <div class="usuario-details">
                <span class="rol-badge">{{ usuario.rol }}</span>
                <span class="empresa-badge">{{
                  getNombreEmpresa(usuario.empresa_id)
                }}</span>
                <span class="status-badge" [class.active]="usuario.activo">
                  {{ usuario.activo ? "Activo" : "Inactivo" }}
                </span>
              </div>
            </div>
            <div class="usuario-actions">
              <button
                class="btn-sm"
                [class.btn-danger]="usuario.activo"
                [class.btn-success]="!usuario.activo"
                (click)="toggleEstadoUsuario(usuario)"
              >
                {{ usuario.activo ? "Desactivar" : "Activar" }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Permisos del usuario seleccionado -->
      <div *ngIf="usuarioSeleccionado" class="permisos-section">
        <div class="permisos-header">
          <h3>Permisos de {{ usuarioSeleccionado.nombre }}</h3>
          <span class="user-status" [class.active]="usuarioSeleccionado.activo">
            {{ usuarioSeleccionado.activo ? "✓ Activo" : "✗ Inactivo" }}
          </span>
        </div>

        <div *ngIf="!usuarioSeleccionado.activo" class="warning-message">
          <i class="fas fa-exclamation-triangle"></i>
          <p>
            El usuario está inactivo. No puede recibir permisos hasta que sea
            activado.
          </p>
        </div>

        <div class="permisos-grid">
          <div *ngFor="let permiso of permisos" class="permiso-item">
            <label class="permiso-checkbox">
              <input
                type="checkbox"
                [checked]="tienePermiso(usuarioSeleccionado.id, permiso.id)"
                (change)="togglePermiso(permiso.id, $event.target.checked)"
                [disabled]="!usuarioSeleccionado.activo"
              />
              <span class="checkmark"></span>
              <div class="permiso-info">
                <strong>{{ permiso.nombre }}</strong>
                <p>{{ permiso.descripcion }}</p>
                <small class="permiso-clave">{{ permiso.clave }}</small>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div
        *ngIf="!usuarioSeleccionado && !isLoading && usuarios.length > 0"
        class="no-selection"
      >
        <i class="fas fa-user-slash"></i>
        <p>Selecciona un usuario para gestionar sus permisos</p>
      </div>
    </div>
  </div>
</div>
